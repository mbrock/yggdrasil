// Generated by CoffeeScript 1.4.0
(function() {
  var __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  $(function() {
    var App, Branches, Node, NodeView, addNode, app, finishLoggingInAs, makeLeaf, nodes, rootNode;
    App = (function(_super) {

      __extends(App, _super);

      function App() {
        return App.__super__.constructor.apply(this, arguments);
      }

      return App;

    })(Backbone.Model);
    Node = (function(_super) {

      __extends(Node, _super);

      function Node() {
        this.addBranch = __bind(this.addBranch, this);

        this.initialize = __bind(this.initialize, this);
        return Node.__super__.constructor.apply(this, arguments);
      }

      Node.prototype.initialize = function() {
        return this.branches = new Branches;
      };

      Node.prototype.addBranch = function(node) {
        return this.branches.add(node);
      };

      return Node;

    })(Backbone.Model);
    Branches = (function(_super) {

      __extends(Branches, _super);

      function Branches() {
        return Branches.__super__.constructor.apply(this, arguments);
      }

      Branches.prototype.model = Node;

      return Branches;

    })(Backbone.Collection);
    NodeView = (function(_super) {

      __extends(NodeView, _super);

      function NodeView() {
        this.submitReply = __bind(this.submitReply, this);

        this.toggleReplyForm = __bind(this.toggleReplyForm, this);

        this.render = __bind(this.render, this);

        this.addChild = __bind(this.addChild, this);

        this.initialize = __bind(this.initialize, this);
        return NodeView.__super__.constructor.apply(this, arguments);
      }

      NodeView.prototype.className = 'node';

      NodeView.prototype.template = _.template($('#node-template').html());

      NodeView.prototype.initialize = function() {
        this.render();
        return this.model.branches.on('add', this.addChild);
      };

      NodeView.prototype.addChild = function(child) {
        var childView;
        childView = new NodeView({
          model: child
        });
        return this.$el.append(childView.el);
      };

      NodeView.prototype.render = function() {
        var htmlContent;
        htmlContent = new Showdown.converter().makeHtml(this.model.get('content'));
        this.$el.append(this.template(_.extend(this.model.toJSON(), {
          htmlContent: htmlContent
        })));
        this.replyForm = this.$el.children('.node-reply-form');
        this.replyForm.hide();
        $('.node-reply-link', this.$el).click(this.toggleReplyForm);
        return this.replyForm.submit(this.submitReply);
      };

      NodeView.prototype.toggleReplyForm = function() {
        this.replyForm.toggle();
        if (this.replyForm.is(':visible')) {
          $('textarea', this.replyForm).focus();
        }
        return false;
      };

      NodeView.prototype.submitReply = function() {
        var content,
          _this = this;
        content = $('textarea', this.replyForm).val();
        if ((content != null) && (app.get('sessionId') != null)) {
          $.ajax({
            type: 'POST',
            url: "/" + (this.model.get('id')),
            data: {
              content: content,
              sessionId: app.get('sessionId')
            },
            success: function() {
              return _this.replyForm.hide();
            }
          });
        }
        return false;
      };

      return NodeView;

    })(Backbone.View);
    nodes = {};
    addNode = function(nodeInfo) {
      var leaf, parent;
      parent = nodes[nodeInfo.parentId];
      leaf = makeLeaf(nodeInfo.id, nodeInfo.content, nodeInfo.userId);
      nodes[nodeInfo.id] = leaf;
      return parent.addBranch(leaf);
    };
    makeLeaf = function(id, content, username) {
      return new Node({
        id: id,
        content: content,
        username: username
      });
    };
    rootNode = makeLeaf(0, '', 'yggdrasil');
    $("#tree").append(new NodeView({
      model: rootNode
    }).el);
    nodes['0'] = rootNode;
    app = new App;
    document.yggdrasil = app;
    $.getJSON("/history", function(data) {
      var event, socket, _i, _len;
      for (_i = 0, _len = data.length; _i < _len; _i++) {
        event = data[_i];
        addNode(event);
      }
      socket = new WebSocket("ws://" + location.hostname + ":8080");
      return socket.onopen = function(event) {
        return socket.onmessage = function(event) {
          return addNode(JSON.parse(event.data));
        };
      };
    });
    $("#login-container button").click(function() {
      var username;
      username = $("#login-container input").val();
      $.ajax({
        type: 'POST',
        dataType: 'json',
        url: "/login/" + username,
        success: function(sessionId) {
          return finishLoggingInAs(username, sessionId);
        }
      });
      return false;
    });
    return finishLoggingInAs = function(username, sessionId) {
      $("#login-container").empty();
      $("#login-container").append($("<p class=\"navbar-text\">Logged in as <i>" + username + "</i></p>"));
      return app.set('sessionId', sessionId);
    };
  });

}).call(this);
